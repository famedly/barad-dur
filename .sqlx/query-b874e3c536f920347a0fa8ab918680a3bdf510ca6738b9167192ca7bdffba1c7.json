{
  "db_name": "PostgreSQL",
  "query": "\n        INSERT INTO\n          aggregated_stats (\n            day,\n            total_users,\n            total_nonbridged_users,\n            total_room_count,\n            daily_active_users,\n            daily_active_rooms,\n            daily_messages,\n            daily_sent_messages,\n            daily_active_e2ee_rooms,\n            daily_e2ee_messages,\n            daily_sent_e2ee_messages,\n            monthly_active_users,\n            r30_users_all,\n            r30_users_android,\n            r30_users_ios,\n            r30_users_electron,\n            r30_users_web,\n            r30v2_users_all,\n            r30v2_users_android,\n            r30v2_users_ios,\n            r30v2_users_electron,\n            r30v2_users_web,\n            daily_user_type_native,\n            daily_user_type_bridged,\n            daily_user_type_guest,\n            daily_active_homeservers\n          )\n        SELECT\n          local_timestamp:: DATE,\n          SUM(total_users),\n          SUM(total_nonbridged_users),\n          SUM(total_room_count),\n          SUM(daily_active_users),\n          SUM(daily_active_rooms),\n          SUM(daily_messages),\n          SUM(daily_sent_messages),\n          SUM(daily_active_e2ee_rooms),\n          SUM(daily_e2ee_messages),\n          SUM(daily_sent_e2ee_messages),\n          SUM(monthly_active_users),\n          SUM(r30_users_all),\n          SUM(r30_users_android),\n          SUM(r30_users_ios),\n          SUM(r30_users_electron),\n          SUM(r30_users_web),\n          SUM(r30v2_users_all),\n          SUM(r30v2_users_android),\n          SUM(r30v2_users_ios),\n          SUM(r30v2_users_electron),\n          SUM(r30v2_users_web),\n          SUM(daily_user_type_native),\n          SUM(daily_user_type_bridged),\n          SUM(daily_user_type_guest),\n          COUNT(homeserver)\n        FROM\n          (\n            SELECT\n              DISTINCT ON (homeserver, local_timestamp:: DATE) *\n            FROM\n              reports\n            WHERE\n              local_timestamp:: DATE >= (\n                SELECT\n                  COALESCE(MAX(day), 'EPOCH':: DATE)\n                FROM\n                  aggregated_stats\n              )\n            ORDER BY\n              homeserver,\n              local_timestamp:: DATE,\n              local_timestamp DESC\n          ) as _\n        GROUP BY\n          local_timestamp:: DATE ON CONFLICT (day) DO\n        UPDATE\n        SET\n          total_users = excluded.total_users,\n          total_nonbridged_users = excluded.total_nonbridged_users,\n          total_room_count = excluded.total_room_count,\n          daily_active_users = excluded.daily_active_users,\n          daily_active_rooms = excluded.daily_active_rooms,\n          daily_messages = excluded.daily_messages,\n          daily_sent_messages = excluded.daily_sent_messages,\n          daily_active_e2ee_rooms = excluded.daily_active_e2ee_rooms,\n          daily_e2ee_messages = excluded.daily_e2ee_messages,\n          daily_sent_e2ee_messages = excluded.daily_sent_e2ee_messages,\n          monthly_active_users = excluded.monthly_active_users,\n          r30_users_all = excluded.r30_users_all,\n          r30_users_android = excluded.r30_users_android,\n          r30_users_ios = excluded.r30_users_ios,\n          r30_users_electron = excluded.r30_users_electron,\n          r30_users_web = excluded.r30_users_web,\n          r30v2_users_all = excluded.r30_users_all,\n          r30v2_users_android = excluded.r30_users_android,\n          r30v2_users_ios = excluded.r30_users_ios,\n          r30v2_users_electron = excluded.r30_users_electron,\n          r30v2_users_web = excluded.r30_users_web,\n          daily_user_type_native = excluded.daily_user_type_native,\n          daily_user_type_bridged = excluded.daily_user_type_bridged,\n          daily_user_type_guest = excluded.daily_user_type_guest,\n          daily_active_homeservers = excluded.daily_active_homeservers;",
  "describe": {
    "columns": [],
    "parameters": {
      "Left": []
    },
    "nullable": []
  },
  "hash": "b874e3c536f920347a0fa8ab918680a3bdf510ca6738b9167192ca7bdffba1c7"
}
