include:
  - project: 'famedly/company/devops/templates/ci-cd'
    ref: rust-v1
    file:
      - '/rust.yml'
  - project: 'famedly/company/devops/templates/ci-cd'
    ref: docker-v1
    file:
      - '/docker.yml'

stages:
  - test
  - deploy

cargo-check:
  extends: .cargo_check
  variables:
    DATABASE_URL: "postgres://baraddur:baraddur@postgres/baraddur"
    POSTGRES_DB: baraddur
    POSTGRES_USER: baraddur
    POSTGRES_PASSWORD: "baraddur"
    POSTGRES_HOST_AUTH_METHOD: trust
  services:
    - name: docker.io/postgres:14-alpine
      alias: postgres
  before_script:
    - !reference [.cargo_common, before_script]
    - cargo install --root=/usr/local sqlx-cli --no-default-features --features postgres
  script:
    - sqlx migrate run
    - cargo sqlx prepare --check
    - !reference [.cargo_check, script]

docker-releases:
  extends: .docker_releases

docker-tags:
  extends: .docker_tags

docker-branches:
  extends: .docker_branches
